<?php
require_once('jwt.php');

if (!isset($_COOKIE['auth_token'])) {
    die("ğŸš« Access Denied. No token found!");
}

$token = $_COOKIE['auth_token'];
$payload = validateJWT($token);

if (!$payload) {
    die("ğŸš« Access Denied. Invalid Token!");
}

$flag = 'RECURSION{miss1on_succ3ss_agent_pablu_09}';
$username = $payload['username'] ?? 'unknown';
$role = $payload['role'] ?? 'none';
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Welcome, Agent <?php echo htmlspecialchars($username); ?></title>
    <link rel="stylesheet" href="/app/assets/css/secret-theme.css">
</head>
<body>
    <div class="container">
        <h1>Welcome, Agent <?php echo htmlspecialchars($username); ?></h1>

        <?php if ($username === 'Pablu' && $role === 'admin'): ?>
            <p>ğŸ‰ Mission complete. Here is your flag: <strong><?php echo $flag; ?></strong></p>
        <?php elseif ($username === 'Pablu' && $role !== 'admin'): ?>
            <p>âš ï¸ You are Agent Pablu, but you are not an admin. Access denied.</p>
        <?php else: ?>
            <p>ğŸ”’ You are logged in as <?php echo htmlspecialchars($username); ?>. Only Agent <strong>Pablu</strong> is authorized to complete the mission.</p>
        <?php endif; ?>
    </div>
</body>
</html>