#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <signal.h>
#include <math.h>
#include <time.h>

const float HOUSE_EDGE = 3.03 / 100;
const int INITIAL_BALANCE = 1000;

void setup()
{
    srand(time(NULL));
    
    alarm(60);

    setvbuf(stdout, NULL, _IONBF, 0);
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stderr, NULL, _IONBF, 0);
}

int main() 
{
    int player[2];
    char player_name[2][48];

    int house;
    int rounds = 0;
    int room;
    int balance = INITIAL_BALANCE;

    setup();

    printf("=====================\n");
    printf("Casino Roulette\n");
    printf("House Edge: %.2f%%\n", HOUSE_EDGE * 100);
    printf("=====================\n");

    printf("You will now play as the house.\n");

    while (1) {
        int choice;
        printf("\n1. Set the player's rounds\n");
        printf("2. Spin the wheel\n");
        printf("3. Exit\n");

        printf("Choice: ");
        scanf("%d%*c", &choice);

        switch (choice) {
            case 1:
                printf("\nEnter the number of rounds: ");
                scanf("%d%*c", &rounds);

                if (rounds > 2) {
                    printf("Invalid number of rounds.\n");
                    break;
                }

                for (int i = 0; i < rounds; i++) {
                    player[i] = 0;
                }

                printf("Which room will the player be in? ");
                scanf("%d%*c", &room);

                room -= 1;
                if (room > 2) {
                    printf("Invalid room.\n");
                    break;
                }

                printf("Enter the player's name: ");
                fgets(player_name[room], 256, stdin);
                break;
            case 2:
                if (rounds == 0) {
                    printf("\nPlease set the number of rounds first.\n");
                    break;
                }

                if (balance <= 0) {
                    printf("\nYou have no more balance.\n");
                    return 0;
                }

                int bet_amount = rand() % (balance + 1);
                printf("Bet amount: %d\n", bet_amount);

                int reset = 1;
                while (reset) {
                    printf("\nSpinning the wheel...\n");
                    house = rand() % (36 + 1);
                    player[0] = rand() % (36 + 1);
                    player[1] = rand() % (36 + 1);

                    int player_low[] = {
                        player[0] % 10,
                        player[1] % 10
                    };
                    int player_high[] = {
                        floor(player[0] / 10),
                        floor(player[1] / 10)
                    };

                    int house_low = house % 10;
                    int house_high = floor(house / 10);

                    int house_sum = house_low + house_high;
                    int player_sum[] = {
                        player_low[0] + player_high[0],
                        player_low[1] + player_high[1]
                    };

                    printf("\nHouse: %d\n", house_sum);
                    for (int i = 0; i < rounds; i++) {
                        printf("Player [%d]: %d\n", i, player_sum[i]);
                    }

                    reset = 0;
                    for (int i = 0; i < rounds; i++) {
                        if (house_sum == 9 && player_sum[i] == 9) {
                            reset = 1;
                            break;
                        }
                        else if (house_sum == 9 || house_sum == 0 || house_sum == 1) {
                            reset = 0;
                        }
                        else if (player_sum[i] == 9) {
                            reset = 0;
                        } 
                        else if (player_sum[i] > house_sum) {
                            reset = 1;
                            break;
                        }
                    }

                    if (!reset) {
                        int win = 1;
                        balance += bet_amount;

                        for (int i = 0; i < rounds; i++) {
                            if (player_sum[i] == 9 || house_sum == 0 || house_sum == 1) {
                                break;
                            }

                            if (player_sum[i] == 1) {
                                balance -= bet_amount * 4;
                                printf("\nPlayer got quads! Player wins!\n");
                                win = 0;
                                break;
                            }
                            else if (player_sum[i] == 0) {
                                balance -= bet_amount * 3;
                                printf("\nPlayer got a straight! Player wins!\n");
                                win = 0;
                                break;
                            }
                            else if (player_sum[i] > house_sum || house_sum == 9) {
                                balance -= bet_amount * 2;
                                printf("\nPlayer wins!\n");
                                win = 0;
                                break;
                            } 
                        }

                        if (win) {
                            printf("\nHouse wins!\n");
                            break;
                        }
                    }
                }
                
                break;
            case 3:
                printf("\nGoodbye!\n");
                return 0;
            default:
                printf("\nInvalid choice.\n");
                break;
        }
    }

    return 0;
}
